# Установка и настройка HAProxy на Ubuntu

## Описание

Скрипт `haproxy.sh` автоматизирует установку HAProxy, создание резервной копии конфигурационного файла и добавление примера конфигурации в конец файла `/etc/haproxy/haproxy.cfg`.

## Что делает скрипт

1. Устанавливает HAProxy через.
2. Создаёт резервную копию текущего конфига (`haproxy.cfg.bak`).
3. Добавляет пример настройки с фронтендом и бекендом в конец файла конфигурации
5. Проверяет синтаксис конфига.
6. Запускает HAProxy и добавляет его в автозагрузку.
7. Показывает статус и версию HAProxy.

## Примечания

- Для доступа к статистике используйте логин `admin` и пароль `pass123` (не забудьте изменить логин и пароль.).
- После выполнения скрипта HAProxy будет слушать HTTP на порту `80` и статистику на порту `8989/haproxy_stats`.


## Проверка работоспособности HAProxy

Настройте три Nginx.

### Редактируем конфиг на node-vm01.local node-vm02.local node-vm03.local
vim /etc/nginx/conf.d/node.conf

```
server {
  listen 8080;

  location / {
    return 200 "Hello, this $HOSTNAME\n";
  }
}
```

### Перечитаем конфигурации для применения изменений

```
systemctl reload nginx
```

### Запустим цикл опроса HAProxy для проверки работоспособности

```
while sleep 0.5; do curl http://haproxy.local; done
```


## Описание балансировки roundrobin

В приведенной конфигурации HAProxy используется тип балансировки `roundrobin`. Это означает, что запросы распределяются по серверам в круговом порядке, по одному запросу на каждый сервер, прежде чем вернуться к первому серверу.


### Плюсы:
1. Простота: алгоритм `roundrobin` очень прост в реализации и понимании. Он не требует сложных вычислений или дополнительных метрик для определения, куда направить следующий запрос.

2. Равномерное распределение нагрузки: в идеальных условиях (когда все серверы имеют одинаковую производительность и обрабатывают запросы за одинаковое время), `roundrobin` обеспечивает равномерное распределение нагрузки между серверами.

3. Отказоустойчивость: если один из серверов выходит из строя, HAProxy может продолжать направлять трафик на оставшиеся работающие серверы, что повышает общую отказоустойчивость системы.

### Минусы:
1. Неравномерная нагрузка: если серверы имеют разную производительность или время обработки запросов, `roundrobin` может привести к неравномерной нагрузке. Например, если один сервер медленнее других, он может не успевать обрабатывать запросы так же быстро, как более быстрые серверы.

2. Отсутствие учета состояния сервера: хотя HAProxy может проверять состояние серверов (как указано в `check`), `roundrobin` не учитывает текущую загрузку серверов при распределении запросов. Это может привести к ситуации, когда один сервер перегружен, а другой простаивает.

3. Проблемы с сессиями: если ваше приложение требует сохранения состояния (например, сессии пользователя), `roundrobin` может привести к проблемам, так как запросы одного пользователя могут направляться на разные серверы. В таких случаях может потребоваться использование других методов балансировки, таких как `sticky sessions`.

### Заключение

Балансировка `roundrobin` является хорошим выбором для простых сценариев, где серверы имеют схожую производительность и приложение не требует сохранения состояния. Однако в более сложных системах может потребоваться использование других алгоритмов балансировки, таких как `leastconn` или `source`, чтобы лучше учитывать нагрузку и требования к сессиям.


## Описание конфигурации

### Настройка веб-интерфейса для мониторинга статистики.

`listen stats` - определяет секцию прослушивания для статистики с именем stats. Секция listen объединяет атрибуты frontend и backend, позволяя настроить сразу оба компонента для данного сервиса.

`bind 0.0.0.0:8989` - указывает HAProxy слушать на всех сетевых интерфейсах (0.0.0.0) и порту 8989 для входящих HTTP-запросов.

`mode http` - устанавливает режим работы для этой секции как http. Это позволяет обрабатывать HTTP-запросы.

`stats enable` - включает веб-интерфейс статистики HAProxy.

`stats uri /haproxy_stats` - определяет URI, по которому будет доступен веб-интерфейс статистики.
В данном случае это `/haproxy_stats`, и доступ к статистике будет осуществляться по адресу `http://<ваш_сервер>:8989/haproxy_stats`.

`stats realm HAProxy Statistics` - определяет название области аутентификации (auth realm) для веб-интерфейса статистики.
В данном случае это `HAProxy Statistics`.

`stats auth admin:pass123` - устанавливает аутентификацию, требующуюся для доступа к веб-интерфейсу. В данном случае это логин: `admin` и пароль: `pass123`.

`stats admin if TRUE` - обозначает, что все пользователи, которые могут пройти аутентификацию, также имеют административные права для управления через веб-интерфейс.


### Обработка входящего HTTP-трафика:

`frontend http_front` - определяет секцию frontend с именем `http_front`. В этой секции настраивается, как HAProxy будет обрабатывать входящий трафик.

`bind *:80` - указывает, что HAProxy должен принимать входящие соединения на всех IP-адресах (*) на порту 80 (обычный HTTP-порт). Это означает, что любой трафик, поступающий на порт 80 на любом сетевом интерфейсе, будет обработан этим frontend'ом.

`default_backend http_back` - определяет название секции backend (http_back), в который будет перенаправлен весь трафик, поступающий с frontend.


### Обработка трафика на конечных серверах:

`backend http_back` - определяет секцию backend с именем `http_back`. В этой секции настраивается, как HAProxy будет распределять трафик между серверами.

`balance roundrobin` - определяет метод балансировки нагрузки `roundrobin` - распределяет запросы по очереди между серверами в круговом порядке, по одному запросу на каждый сервер.

`server nginx01 node-vm01.local:8080 check` - определяет сервера с именем nginx01-03, который доступны по доменным имена и порту 8080. Ключевое слово `check` указывает HAProxy, что он должен периодически проверять этот сервер на доступность.
