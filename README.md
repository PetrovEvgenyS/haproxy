# Установка и настройка HAProxy

## Описание

Скрипт `haproxy.sh` автоматизирует установку HAProxy, создание резервной копии конфигурационного файла и добавление примера конфигурации в конец файла `/etc/haproxy/haproxy.cfg`.

## Что делает скрипт

1. Устанавливает HAProxy через.
2. Создаёт резервную копию текущего конфига (`haproxy.cfg.bak`).
3. Добавляет пример настройки с фронтендом и бекендом в конец файла конфигурации
5. Проверяет синтаксис конфига.
6. Запускает HAProxy и добавляет его в автозагрузку.
7. Показывает статус и версию HAProxy.

## Примечания

- Для доступа к статистике используйте логин `admin` и пароль `pass123` (не забудьте изменить логин и пароль.).
- После выполнения скрипта HAProxy будет слушать HTTP на порту `80` и статистику на порту `8989/haproxy_stats`.


## Проверка работоспособности HAProxy

Настройте три Nginx.

### Редактируем конфиг на node-vm01.local node-vm02.local node-vm03.local
vim /etc/nginx/conf.d/node.conf

```
server {
  listen 8080;

  location / {
    return 200 "Hello, this $HOSTNAME\n";
  }
}
```

### Перечитаем конфигурации для применения изменений

```
systemctl reload nginx
```

### Запустим цикл опроса HAProxy для проверки работоспособности

```
while sleep 0.5; do curl http://haproxy.local; done
```

### Описание настроенной балансировки

В приведенной конфигурации HAProxy используется тип балансировки `roundrobin`. Это означает, что запросы распределяются по серверам в круговом порядке, по одному запросу на каждый сервер, прежде чем вернуться к первому серверу.


#### Плюсы:
1. Простота: алгоритм `roundrobin` очень прост в реализации и понимании. Он не требует сложных вычислений или дополнительных метрик для определения, куда направить следующий запрос.

2. Равномерное распределение нагрузки: в идеальных условиях (когда все серверы имеют одинаковую производительность и обрабатывают запросы за одинаковое время), `roundrobin` обеспечивает равномерное распределение нагрузки между серверами.

3. Отказоустойчивость: если один из серверов выходит из строя, HAProxy может продолжать направлять трафик на оставшиеся работающие серверы, что повышает общую отказоустойчивость системы.

#### Минусы:
1. Неравномерная нагрузка: если серверы имеют разную производительность или время обработки запросов, `roundrobin` может привести к неравномерной нагрузке. Например, если один сервер медленнее других, он может не успевать обрабатывать запросы так же быстро, как более быстрые серверы.

2. Отсутствие учета состояния сервера: хотя HAProxy может проверять состояние серверов (как указано в `check`), `roundrobin` не учитывает текущую загрузку серверов при распределении запросов. Это может привести к ситуации, когда один сервер перегружен, а другой простаивает.

3. Проблемы с сессиями: если ваше приложение требует сохранения состояния (например, сессии пользователя), `roundrobin` может привести к проблемам, так как запросы одного пользователя могут направляться на разные серверы. В таких случаях может потребоваться использование других методов балансировки, таких как `sticky sessions`.

### Заключение

Балансировка `roundrobin` является хорошим выбором для простых сценариев, где серверы имеют схожую производительность и приложение не требует сохранения состояния. Однако в более сложных системах может потребоваться использование других алгоритмов балансировки, таких как `leastconn` или `source`, чтобы лучше учитывать нагрузку и требования к сессиям.